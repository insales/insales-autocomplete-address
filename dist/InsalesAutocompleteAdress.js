/*! InsalesAutocompleteAddress v0.4.0
https://github.com/insales/insales-autocomplete-address/ */!function(){"use strict";var e={d:function(t,n){for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},o:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}},t={};function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}e.d(t,{default:function(){return g}});var i,l=function(e,t){return e.matches?e.matches(t):e.msMatchesSelector?e.msMatchesSelector(t):e.webkitMatchesSelector?e.webkitMatchesSelector(t):null},r=function(e,t){return e.closest?e.closest(t):function(e,t){for(var n=e;n&&1===n.nodeType;){if(l(n,t))return n;n=n.parentNode}return null}(e,t)},u=function e(){var t,s=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},l=i.search,u=i.autoSelect,a=void 0!==u&&u,c=i.setValue,d=void 0===c?function(){}:c,h=i.setAttribute,p=void 0===h?function(){}:h,b=i.onUpdate,f=void 0===b?function(){}:b,v=i.onSubmit,m=void 0===v?function(){}:v,g=i.onShow,y=void 0===g?function(){}:g,L=i.autocorrect,w=void 0!==L&&L,S=i.onHide,R=void 0===S?function(){}:S,E=i.onLoading,A=void 0===E?function(){}:E,x=i.onLoaded,k=void 0===x?function(){}:x,C=i.submitOnEnter,I=void 0!==C&&C;n(this,e),o(this,"value",""),o(this,"searchCounter",0),o(this,"results",[]),o(this,"selectedIndex",-1),o(this,"selectedResult",null),o(this,"destroy",(function(){s.search=null,s.setValue=null,s.setAttribute=null,s.onUpdate=null,s.onSubmit=null,s.autocorrect=null,s.onShow=null,s.onHide=null,s.onLoading=null,s.onLoaded=null})),o(this,"handleInput",(function(e){var t=e.target.value;s.updateResults(t),s.value=t})),o(this,"handleKeyDown",(function(e){var t=e.key;switch(t){case"Up":case"Down":case"ArrowUp":case"ArrowDown":var n="ArrowUp"===t||"Up"===t?s.selectedIndex-1:s.selectedIndex+1;e.preventDefault(),s.handleArrows(n);break;case"Tab":s.selectResult();break;case"Enter":var o=e.target.getAttribute("aria-activedescendant").length>0;s.selectedResult=s.results[s.selectedIndex]||s.selectedResult,s.selectResult(),s.submitOnEnter?s.selectedResult&&s.onSubmit(s.selectedResult):o?e.preventDefault():(s.selectedResult&&s.onSubmit(s.selectedResult),s.selectedResult=null);break;case"Esc":case"Escape":s.hideResults(),s.setValue();break;default:return}})),o(this,"handleFocus",(function(e){var t=e.target.value;s.updateResults(t),s.value=t})),o(this,"handleBlur",(function(){s.hideResults()})),o(this,"handleResultMouseDown",(function(e){e.preventDefault()})),o(this,"handleResultClick",(function(e){var t=e.target,n=r(t,"[data-result-index]");if(n){s.selectedIndex=parseInt(n.dataset.resultIndex,10);var o=s.results[s.selectedIndex];s.selectResult(),s.onSubmit(o)}})),o(this,"handleArrows",(function(e){var t=s.results.length;s.selectedIndex=(e%t+t)%t,s.onUpdate(s.results,s.selectedIndex)})),o(this,"selectResult",(function(){var e=s.results[s.selectedIndex];e&&s.setValue(e),s.hideResults()})),o(this,"updateResults",(function(e){var t=++s.searchCounter;s.onLoading(),s.search(e).then((function(e){t===s.searchCounter&&(s.results=e,s.onLoaded(),0!==s.results.length?(s.selectedIndex=s.autoSelect?0:-1,s.onUpdate(s.results,s.selectedIndex),s.showResults()):s.hideResults())}))})),o(this,"showResults",(function(){s.setAttribute("aria-expanded",!0),s.onShow()})),o(this,"hideResults",(function(){s.selectedIndex=-1,s.results=[],s.setAttribute("aria-expanded",!1),s.setAttribute("aria-activedescendant",""),s.onUpdate(s.results,s.selectedIndex),s.onHide()})),o(this,"checkSelectedResultVisible",(function(e){var t=e.querySelector('[data-result-index="'.concat(s.selectedIndex,'"]'));if(t){var n=e.getBoundingClientRect(),o=t.getBoundingClientRect();o.top<n.top?e.scrollTop-=n.top-o.top:o.bottom>n.bottom&&(e.scrollTop+=o.bottom-n.bottom)}})),this.search=(t=l,Boolean(t&&"function"==typeof t.then)?l:function(e){return Promise.resolve(l(e))}),this.autoSelect=a,this.setValue=d,this.setAttribute=p,this.onUpdate=f,this.onSubmit=m,this.autocorrect=w,this.onShow=y,this.onHide=R,this.onLoading=A,this.onLoaded=k,this.submitOnEnter=I},a=0,c=function(){function e(t,s,o){n(this,e),this.id="".concat(o,"-result-").concat(t),this.class="".concat(o,"-result"),this["data-result-index"]=t,this.role="option",t===s&&(this["aria-selected"]="true")}var t,o,i;return t=e,(o=[{key:"toString",value:function(){var e=this;return Object.keys(this).reduce((function(t,n){return"".concat(t," ").concat(n,'="').concat(e[n],'"')}),"")}}])&&s(t.prototype,o),i&&s(t,i),e}(),d=function e(t){var s=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},l=i.search,r=i.onSubmit,d=void 0===r?function(){}:r,h=i.onUpdate,p=void 0===h?function(){}:h,b=i.baseClass,f=void 0===b?"autocomplete":b,v=i.autocorrect,m=void 0!==v&&v,g=i.autoSelect,y=i.getResultValue,L=void 0===y?function(e){return e}:y,w=i.renderResult,S=i.debounceTime,R=void 0===S?0:S,E=i.resultListLabel,A=i.submitOnEnter,x=void 0!==A&&A;n(this,e),o(this,"expanded",!1),o(this,"loading",!1),o(this,"position",{}),o(this,"resetPosition",!0),o(this,"initialize",(function(){s.root.style.position="relative",s.input.setAttribute("role","combobox"),s.input.setAttribute("autocomplete","off"),s.input.setAttribute("autocapitalize","off"),s.autocorrect&&s.input.setAttribute("autocorrect","on"),s.input.setAttribute("spellcheck","false"),s.input.setAttribute("aria-autocomplete","list"),s.input.setAttribute("aria-haspopup","listbox"),s.input.setAttribute("aria-expanded","false"),s.resultList.setAttribute("role","listbox");var e=function(e){if(null==e?void 0:e.length){var t=e.startsWith("#");return{attribute:t?"aria-labelledby":"aria-label",content:t?e.substring(1):e}}}(s.resultListLabel);e&&s.resultList.setAttribute(e.attribute,e.content),s.resultList.style.position="absolute",s.resultList.style.zIndex="1",s.resultList.style.width="100%",s.resultList.style.boxSizing="border-box",s.resultList.id||(s.resultList.id=function(){return"".concat(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").concat(++a)}("".concat(s.baseClass,"-result-list-"))),s.input.setAttribute("aria-owns",s.resultList.id),document.body.addEventListener("click",s.handleDocumentClick),s.input.addEventListener("input",s.core.handleInput),s.input.addEventListener("keydown",s.core.handleKeyDown),s.input.addEventListener("focus",s.core.handleFocus),s.input.addEventListener("blur",s.core.handleBlur),s.resultList.addEventListener("mousedown",s.core.handleResultMouseDown),s.resultList.addEventListener("click",s.core.handleResultClick),s.updateStyle()})),o(this,"destroy",(function(){document.body.removeEventListener("click",s.handleDocumentClick),s.input.removeEventListener("input",s.core.handleInput),s.input.removeEventListener("keydown",s.core.handleKeyDown),s.input.removeEventListener("focus",s.core.handleFocus),s.input.removeEventListener("blur",s.core.handleBlur),s.resultList.removeEventListener("mousedown",s.core.handleResultMouseDown),s.resultList.removeEventListener("click",s.core.handleResultClick),s.root=null,s.input=null,s.resultList=null,s.getResultValue=null,s.onUpdate=null,s.renderResult=null,s.core.destroy(),s.core=null})),o(this,"setAttribute",(function(e,t){s.input.setAttribute(e,t)})),o(this,"setValue",(function(e){s.input.value=e?s.getResultValue(e):""})),o(this,"renderResult",(function(e,t){return"<li ".concat(t,">").concat(s.getResultValue(e),"</li>")})),o(this,"handleUpdate",(function(e,t){var n,o,i,l;s.resultList.innerHTML="",e.forEach((function(e,n){var o=new c(n,t,s.baseClass),i=s.renderResult(e,o);"string"==typeof i?s.resultList.insertAdjacentHTML("beforeend",i):s.resultList.insertAdjacentElement("beforeend",i)})),s.input.setAttribute("aria-activedescendant",t>-1?"".concat(s.baseClass,"-result-").concat(t):""),s.resetPosition&&(s.resetPosition=!1,s.position=(n=s.input,o=s.resultList,i=n.getBoundingClientRect(),l=o.getBoundingClientRect(),i.bottom+l.height>window.innerHeight&&window.innerHeight-i.bottom<i.top&&window.pageYOffset+i.top-l.height>0?"above":"below"),s.updateStyle()),s.core.checkSelectedResultVisible(s.resultList),s.onUpdate(e,t)})),o(this,"handleShow",(function(){s.expanded=!0,s.updateStyle()})),o(this,"handleHide",(function(){s.expanded=!1,s.resetPosition=!0,s.updateStyle()})),o(this,"handleLoading",(function(){s.loading=!0,s.updateStyle()})),o(this,"handleLoaded",(function(){s.loading=!1,s.updateStyle()})),o(this,"handleDocumentClick",(function(e){s.root.contains(e.target)||s.core.hideResults()})),o(this,"updateStyle",(function(){s.root.dataset.expanded=s.expanded,s.root.dataset.loading=s.loading,s.root.dataset.position=s.position,s.resultList.style.visibility=s.expanded?"visible":"hidden",s.resultList.style.pointerEvents=s.expanded?"auto":"none","below"===s.position?(s.resultList.style.bottom=null,s.resultList.style.top="100%"):(s.resultList.style.top=null,s.resultList.style.bottom="100%")})),this.root="string"==typeof t?document.querySelector(t):t,this.input=this.root.querySelector("input"),this.resultList=this.root.querySelector("ul"),this.baseClass=f,this.autocorrect=m,this.getResultValue=L,this.onUpdate=p,"function"==typeof w&&(this.renderResult=w),this.resultListLabel=E,this.submitOnEnter=x;var k,C,I,U,V=new u({search:l,autoSelect:g,setValue:this.setValue,setAttribute:this.setAttribute,onUpdate:this.handleUpdate,autocorrect:this.autocorrect,onSubmit:d,onShow:this.handleShow,onHide:this.handleHide,onLoading:this.handleLoading,onLoaded:this.handleLoaded,submitOnEnter:this.submitOnEnter});R>0&&(V.handleInput=(k=V.handleInput,C=R,function(){var e=this,t=arguments,n=I&&!U;clearTimeout(U),U=setTimeout((function(){U=null,I||k.apply(e,t)}),C),n&&k.apply(e,t)})),this.core=V,this.initialize()},h=(i=0,e=>new Promise((t=>{let n=document.createElement("script"),s="_jsonp_"+i++;e.match(/\?/)?e+="&callback="+s:e+="?callback="+s,n.src=e,window[s]=e=>{t(new Response(JSON.stringify(e))),n.remove(),delete window[s]},document.body.appendChild(n)}))),p=(e,t)=>{const n=`https://kladr.insales.ru/fulltext_search.json?q=${e}&country=${t}&with_parent=1`;return new Promise(((t,s)=>{if(e.length<2)return t([]);h(n,{mode:"no-cors",method:"GET"}).then((e=>e.json())).then((e=>{e.error?s(e.error):t(e)})).catch((e=>{s(e)}))}))};let b=(e,t)=>{var n=new CustomEvent(e,{detail:{data:t}});document.dispatchEvent(n)},f=()=>new Promise(((e,t)=>{h("https://kladr.insales.ru/locate.json",{mode:"no-cors",method:"GET"}).then((e=>e.json())).then((t=>{e(t)})).catch((e=>{t(e)}))}));var v=(e,t)=>new Promise(((n,s)=>{if(!localStorage&&t||localStorage&&!localStorage[e]&&t)f().then((e=>{n(e)})).catch((e=>{n(null)}));else try{let t=JSON.parse(localStorage[e]);n(t)}catch(e){n(null)}})),m=(e,t,n)=>(b("update:lacation:insales:autocomplete:address",t),new Promise(((n,s)=>{if(localStorage)try{localStorage[e]=JSON.stringify(t),n()}catch(e){s(e)}else n()})));var g=class{constructor(e,{onChange:t=()=>{},autoLocation:n=!0,country:s="RU",debounceTime:o=0}){this.options={onChange:t,debounceTime:o,autoLocation:n,country:s},this.items=document.querySelectorAll(e),this.storageKey="InsalesAutocompleteAddress",this.currentLocation="",this.searchQuery="",this.AutocompleteInstance=null,this.items.length&&(v(this.storageKey,this.options.autoLocation).then((e=>{this.items.forEach((t=>{this.createAutocomplete(t),e&&m(this.storageKey,e)}))})),document.addEventListener("update:lacation:insales:autocomplete:address",(e=>{this.setValue(e.detail.data),this.options.onChange(e.detail.data),this.currentLocation=e.detail.data.result})))}setValue(e){this.items.forEach((t=>{let n=t.querySelector(".insales-autocomplete-address-input");e.result&&n&&n.value!==e.result&&(n.value=e.result)}))}setCountry(e){this.options.country=e,p(this.searchQuery,this.options.country)}createAutocomplete(e){let t=this.options,n=e.querySelector(".insales-autocomplete-address-input");n&&(n.onkeydown=function(e){if(13===e.which)return e.preventDefault(),e.stopPropagation(),!1}),e.classList.add("insales-autocomplete-address"),this.AutocompleteInstance=new d(e,{search:e=>(this.searchQuery=e,new Promise(((n,s)=>{p(e,t.country).then((t=>{0==t.length&&e.length>5?n([{isError:!0,result:"Город не найден"}]):n(t)})).catch((t=>{""!=e&&n([{isError:!0,result:"Город не найден"}])}))}))),baseClass:"insales-autocomplete-address",autoSelect:!0,debounceTime:t.debounceTime,getResultValue:e=>e.isError?this.currentLocation:e.result,renderResult:(e,t)=>`\n          <li ${t}>\n            <div class="insales-autocomplete-address-title">\n              ${((e,t)=>{let n=new RegExp(`(${t})`,"gi");return e.replace(n,"<strong>$1</strong>")})(e.result,this.searchQuery)}\n            </div>\n          </li>\n        `,onSubmit:e=>{e&&!e.isError&&m(this.storageKey,e,n)}})}};window.InsalesAutocompleteAdress=t.default}();