/*! InsalesAutocompleteAddress v1.0.1
https://github.com/insales/insales-autocomplete-address/ */!function(){"use strict";var t={d:function(e,n){for(var s in n)t.o(n,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:n[s]})},o:function(t,e){return Object.prototype.hasOwnProperty.call(t,e)}},e={};function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e,n){return e&&function(t,e){for(var n=0;n<e.length;n++){var s=e[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,o(s.key),s)}}(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}function i(t,e,n){return(e=o(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var s=n.call(t,e||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}t.d(e,{default:function(){return g}});var r,l=function(t,e){return t.matches?t.matches(e):t.msMatchesSelector?t.msMatchesSelector(e):t.webkitMatchesSelector?t.webkitMatchesSelector(e):null},a=function(t,e){return t.closest?t.closest(e):function(t,e){for(var n=t;n&&1===n.nodeType;){if(l(n,e))return n;n=n.parentNode}return null}(t,e)},u=s((function t(){var e,s=this,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=o.search,l=o.autoSelect,u=void 0!==l&&l,c=o.setValue,d=void 0===c?function(){}:c,h=o.setAttribute,p=void 0===h?function(){}:h,b=o.onUpdate,f=void 0===b?function(){}:b,m=o.onSubmit,v=void 0===m?function(){}:m,y=o.onShow,g=void 0===y?function(){}:y,L=o.autocorrect,w=void 0!==L&&L,S=o.onHide,R=void 0===S?function(){}:S,A=o.onLoading,E=void 0===A?function(){}:A,x=o.onLoaded,k=void 0===x?function(){}:x,I=o.submitOnEnter,C=void 0!==I&&I;n(this,t),i(this,"value",""),i(this,"searchCounter",0),i(this,"results",[]),i(this,"selectedIndex",-1),i(this,"selectedResult",null),i(this,"destroy",(function(){s.search=null,s.setValue=null,s.setAttribute=null,s.onUpdate=null,s.onSubmit=null,s.autocorrect=null,s.onShow=null,s.onHide=null,s.onLoading=null,s.onLoaded=null})),i(this,"handleInput",(function(t){var e=t.target.value;s.updateResults(e),s.value=e})),i(this,"handleKeyDown",(function(t){var e=t.key;switch(e){case"Up":case"Down":case"ArrowUp":case"ArrowDown":var n="ArrowUp"===e||"Up"===e?s.selectedIndex-1:s.selectedIndex+1;t.preventDefault(),s.handleArrows(n);break;case"Tab":s.selectResult();break;case"Enter":var i=t.target.getAttribute("aria-activedescendant").length>0;s.selectedResult=s.results[s.selectedIndex]||s.selectedResult,s.selectResult(),s.submitOnEnter?s.selectedResult&&s.onSubmit(s.selectedResult):i?t.preventDefault():(s.selectedResult&&s.onSubmit(s.selectedResult),s.selectedResult=null);break;case"Esc":case"Escape":s.hideResults(),s.setValue();break;default:return}})),i(this,"handleFocus",(function(t){var e=t.target.value;s.updateResults(e),s.value=e})),i(this,"handleBlur",(function(){s.hideResults()})),i(this,"handleResultMouseDown",(function(t){t.preventDefault()})),i(this,"handleResultClick",(function(t){var e=t.target,n=a(e,"[data-result-index]");if(n){s.selectedIndex=parseInt(n.dataset.resultIndex,10);var i=s.results[s.selectedIndex];s.selectResult(),s.onSubmit(i)}})),i(this,"handleArrows",(function(t){var e=s.results.length;s.selectedIndex=(t%e+e)%e,s.onUpdate(s.results,s.selectedIndex)})),i(this,"selectResult",(function(){var t=s.results[s.selectedIndex];t&&s.setValue(t),s.hideResults()})),i(this,"updateResults",(function(t){var e=++s.searchCounter;s.onLoading(),s.search(t).then((function(t){e===s.searchCounter&&(s.results=t,s.onLoaded(),0!==s.results.length?(s.selectedIndex=s.autoSelect?0:-1,s.onUpdate(s.results,s.selectedIndex),s.showResults()):s.hideResults())}))})),i(this,"showResults",(function(){s.setAttribute("aria-expanded",!0),s.onShow()})),i(this,"hideResults",(function(){s.selectedIndex=-1,s.results=[],s.setAttribute("aria-expanded",!1),s.setAttribute("aria-activedescendant",""),s.onUpdate(s.results,s.selectedIndex),s.onHide()})),i(this,"checkSelectedResultVisible",(function(t){var e=t.querySelector('[data-result-index="'.concat(s.selectedIndex,'"]'));if(e){var n=t.getBoundingClientRect(),i=e.getBoundingClientRect();i.top<n.top?t.scrollTop-=n.top-i.top:i.bottom>n.bottom&&(t.scrollTop+=i.bottom-n.bottom)}})),this.search=(e=r,Boolean(e&&"function"==typeof e.then)?r:function(t){return Promise.resolve(r(t))}),this.autoSelect=u,this.setValue=d,this.setAttribute=p,this.onUpdate=f,this.onSubmit=v,this.autocorrect=w,this.onShow=g,this.onHide=R,this.onLoading=E,this.onLoaded=k,this.submitOnEnter=C})),c=0,d=function(){return s((function t(e,s,i){n(this,t),this.id="".concat(i,"-result-").concat(e),this.class="".concat(i,"-result"),this["data-result-index"]=e,this.role="option",e===s&&(this["aria-selected"]="true")}),[{key:"toString",value:function(){var t=this;return Object.keys(this).reduce((function(e,n){return"".concat(e," ").concat(n,'="').concat(t[n],'"')}),"")}}])}(),h=s((function t(e){var s=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=o.search,l=o.onSubmit,a=void 0===l?function(){}:l,h=o.onUpdate,p=void 0===h?function(){}:h,b=o.baseClass,f=void 0===b?"autocomplete":b,m=o.autocorrect,v=void 0!==m&&m,y=o.autoSelect,g=o.getResultValue,L=void 0===g?function(t){return t}:g,w=o.renderResult,S=o.debounceTime,R=void 0===S?0:S,A=o.resultListLabel,E=o.submitOnEnter,x=void 0!==E&&E;n(this,t),i(this,"expanded",!1),i(this,"loading",!1),i(this,"position",{}),i(this,"resetPosition",!0),i(this,"initialize",(function(){s.root.style.position="relative",s.input.setAttribute("role","combobox"),s.input.setAttribute("autocomplete","off"),s.input.setAttribute("autocapitalize","off"),s.autocorrect&&s.input.setAttribute("autocorrect","on"),s.input.setAttribute("spellcheck","false"),s.input.setAttribute("aria-autocomplete","list"),s.input.setAttribute("aria-haspopup","listbox"),s.input.setAttribute("aria-expanded","false"),s.resultList.setAttribute("role","listbox");var t=function(t){if(null!=t&&t.length){var e=t.startsWith("#");return{attribute:e?"aria-labelledby":"aria-label",content:e?t.substring(1):t}}}(s.resultListLabel);t&&s.resultList.setAttribute(t.attribute,t.content),s.resultList.style.position="absolute",s.resultList.style.zIndex="1",s.resultList.style.width="100%",s.resultList.style.boxSizing="border-box",s.resultList.id||(s.resultList.id=function(){return"".concat(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").concat(++c)}("".concat(s.baseClass,"-result-list-"))),s.input.setAttribute("aria-owns",s.resultList.id),document.body.addEventListener("click",s.handleDocumentClick),s.input.addEventListener("input",s.core.handleInput),s.input.addEventListener("keydown",s.core.handleKeyDown),s.input.addEventListener("focus",s.core.handleFocus),s.input.addEventListener("blur",s.core.handleBlur),s.resultList.addEventListener("mousedown",s.core.handleResultMouseDown),s.resultList.addEventListener("click",s.core.handleResultClick),s.updateStyle()})),i(this,"destroy",(function(){document.body.removeEventListener("click",s.handleDocumentClick),s.input.removeEventListener("input",s.core.handleInput),s.input.removeEventListener("keydown",s.core.handleKeyDown),s.input.removeEventListener("focus",s.core.handleFocus),s.input.removeEventListener("blur",s.core.handleBlur),s.resultList.removeEventListener("mousedown",s.core.handleResultMouseDown),s.resultList.removeEventListener("click",s.core.handleResultClick),s.root=null,s.input=null,s.resultList=null,s.getResultValue=null,s.onUpdate=null,s.renderResult=null,s.core.destroy(),s.core=null})),i(this,"setAttribute",(function(t,e){s.input.setAttribute(t,e)})),i(this,"setValue",(function(t){s.input.value=t?s.getResultValue(t):""})),i(this,"renderResult",(function(t,e){return"<li ".concat(e,">").concat(s.getResultValue(t),"</li>")})),i(this,"handleUpdate",(function(t,e){var n,i,o,r;s.resultList.innerHTML="",t.forEach((function(t,n){var i=new d(n,e,s.baseClass),o=s.renderResult(t,i);"string"==typeof o?s.resultList.insertAdjacentHTML("beforeend",o):s.resultList.insertAdjacentElement("beforeend",o)})),s.input.setAttribute("aria-activedescendant",e>-1?"".concat(s.baseClass,"-result-").concat(e):""),s.resetPosition&&(s.resetPosition=!1,s.position=(n=s.input,i=s.resultList,o=n.getBoundingClientRect(),r=i.getBoundingClientRect(),o.bottom+r.height>window.innerHeight&&window.innerHeight-o.bottom<o.top&&window.pageYOffset+o.top-r.height>0?"above":"below"),s.updateStyle()),s.core.checkSelectedResultVisible(s.resultList),s.onUpdate(t,e)})),i(this,"handleShow",(function(){s.expanded=!0,s.updateStyle()})),i(this,"handleHide",(function(){s.expanded=!1,s.resetPosition=!0,s.updateStyle()})),i(this,"handleLoading",(function(){s.loading=!0,s.updateStyle()})),i(this,"handleLoaded",(function(){s.loading=!1,s.updateStyle()})),i(this,"handleDocumentClick",(function(t){s.root.contains(t.target)||s.core.hideResults()})),i(this,"updateStyle",(function(){s.root.dataset.expanded=s.expanded,s.root.dataset.loading=s.loading,s.root.dataset.position=s.position,s.resultList.style.visibility=s.expanded?"visible":"hidden",s.resultList.style.pointerEvents=s.expanded?"auto":"none","below"===s.position?(s.resultList.style.bottom=null,s.resultList.style.top="100%"):(s.resultList.style.top=null,s.resultList.style.bottom="100%")})),this.root="string"==typeof e?document.querySelector(e):e,this.input=this.root.querySelector("input"),this.resultList=this.root.querySelector("ul"),this.baseClass=f,this.autocorrect=v,this.getResultValue=L,this.onUpdate=p,"function"==typeof w&&(this.renderResult=w),this.resultListLabel=A,this.submitOnEnter=x;var k,I,C,U=new u({search:r,autoSelect:y,setValue:this.setValue,setAttribute:this.setAttribute,onUpdate:this.handleUpdate,autocorrect:this.autocorrect,onSubmit:a,onShow:this.handleShow,onHide:this.handleHide,onLoading:this.handleLoading,onLoaded:this.handleLoaded,submitOnEnter:this.submitOnEnter});R>0&&(U.handleInput=(k=U.handleInput,I=R,function(){var t=this,e=arguments;clearTimeout(C),C=setTimeout((function(){C=null,k.apply(t,e)}),I)})),this.core=U,this.initialize()})),p=(r=0,t=>new Promise((e=>{let n=document.createElement("script"),s="_jsonp_"+r++;t.match(/\?/)?t+="&callback="+s:t+="?callback="+s,n.src=t,window[s]=t=>{e(new Response(JSON.stringify(t))),n.remove(),delete window[s]},document.body.appendChild(n)}))),b=(t,e)=>{const n=`https://kladr.insales.ru/fulltext_search.json?q=${t}&country=${e}&with_parent=1`;return new Promise(((e,s)=>{if(t.length<2)return e([]);p(n,{mode:"no-cors",method:"GET"}).then((t=>t.json())).then((t=>{t.error?s(t.error):e(t)})).catch((t=>{s(t)}))}))};let f=(t,e)=>{var n=new CustomEvent(t,{detail:{data:e}});document.dispatchEvent(n)},m=()=>new Promise(((t,e)=>{p("https://kladr.insales.ru/locate.json",{mode:"no-cors",method:"GET"}).then((t=>t.json())).then((e=>{t(e)})).catch((t=>{e(t)}))}));var v=(t,{autoLocation:e,country:n,initialFulltextSearch:s})=>new Promise((i=>{if(!localStorage||localStorage&&!localStorage[t]&&(e||s))s?b(s,n).then((t=>{0===t.length?i(null):i(t[0])})).catch((()=>{""!==input&&i(null)})):m().then(i).catch((()=>i(null)));else try{const e=JSON.parse(localStorage[t]);i(e)}catch(t){i(null)}})),y=(t,e)=>(f("update:location:insales:autocomplete:address",e),new Promise(((n,s)=>{if(localStorage)try{localStorage[t]=JSON.stringify(e),n()}catch(t){s(t)}else n()})));var g=class{constructor(t,{onChange:e=()=>{},autoLocation:n=!0,initialFulltextSearch:s=null,country:i="RU",debounceTime:o=0}){this.options={onChange:e,debounceTime:o,autoLocation:n,country:i,initialFulltextSearch:s},this.originalSelector=t,this.items=document.querySelectorAll(t),this.storageKey="InsalesAutocompleteAddress",this.currentLocation="",this.searchQuery="",this.AutocompleteInstance=null,this.boundHandleLocationUpdate=this.handleLocationUpdate.bind(this),this.items.length&&this.init()}init(){v(this.storageKey,this.options).then((t=>{this.items.forEach((e=>{this.createAutocomplete(e),t&&y(this.storageKey,t)}))})),document.addEventListener("update:location:insales:autocomplete:address",this.boundHandleLocationUpdate)}initWithoutLocation(){this.items.forEach((t=>{this.createAutocomplete(t)})),document.addEventListener("update:location:insales:autocomplete:address",this.boundHandleLocationUpdate)}setValue(t){this.items.forEach((e=>{const n=e.querySelector(".insales-autocomplete-address-input");t.result&&n&&n.value!==t.result&&(n.value=t.result,n.setAttribute("value",t.result))}))}setCountry(t){this.options.country=t}createAutocomplete(t){const e=this.options,n=t.querySelector(".insales-autocomplete-address-input");n&&(n.onkeydown=t=>{if("Enter"===t.key)return t.preventDefault(),t.stopPropagation(),!1}),t.classList.add("insales-autocomplete-address"),this.AutocompleteInstance=new h(t,{search:this.handleSearch.bind(this),baseClass:"insales-autocomplete-address",autoSelect:!0,debounceTime:e.debounceTime,getResultValue:this.getResultValue.bind(this),renderResult:this.renderResult.bind(this),onSubmit:this.handleSubmit.bind(this)})}handleSearch(t){return this.searchQuery=t,new Promise((e=>{b(t,this.options.country).then((n=>{0===n.length&&t.length>5?e([{isError:!0,result:"Город не найден"}]):e(n)})).catch((()=>{""!==t&&e([{isError:!0,result:"Город не найден"}])}))}))}getResultValue(t){return t.isError?this.currentLocation:t.result}renderResult(t,e){return`\n      <li ${e}>\n        <div class="insales-autocomplete-address-title">\n          ${((t,e)=>{let n=new RegExp(`(${e})`,"gi");return t.replace(n,"<strong>$1</strong>")})(t.result,this.searchQuery)}\n        </div>\n      </li>\n    `}handleSubmit(t){t&&!t.isError&&y(this.storageKey,t,this.$input)}handleLocationUpdate(t){this.setValue(t.detail.data),this.options.onChange(t.detail.data),this.currentLocation=t.detail.data.result}destroy(){this.AutocompleteInstance&&"function"==typeof this.AutocompleteInstance.destroy&&this.AutocompleteInstance.destroy(),document.removeEventListener("update:location:insales:autocomplete:address",this.boundHandleLocationUpdate),this.AutocompleteInstance=null,this.items=null,this.currentLocation="",this.searchQuery=""}recreate({withLocation:t=!1}={}){this.destroy(),this.items=document.querySelectorAll(this.originalSelector),this.items.length&&(this.boundHandleLocationUpdate=this.handleLocationUpdate.bind(this),t?this.init():this.initWithoutLocation())}};window.InsalesAutocompleteAdress=e.default}();